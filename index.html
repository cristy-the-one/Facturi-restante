<!DOCTYPE html>
<html lang="ro">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Analizor Facturi Restante (EP.SRL)</title>
  <!-- SheetJS library for Excel file parsing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: white;
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
      overflow: hidden;
    }

    .header {
      background: linear-gradient(45deg, #2c3e50, #34495e);
      color: white;
      padding: 30px;
      text-align: center;
    }

    .header h1 {
      font-size: 2.2em;
      margin-bottom: 10px;
    }

    .header p {
      opacity: 0.9;
      font-size: 1.1em;
    }

    .content {
      padding: 40px;
    }

    .upload-section {
      background: #f8f9fa;
      border: 3px dashed #dee2e6;
      border-radius: 10px;
      padding: 40px;
      text-align: center;
      margin-bottom: 30px;
      transition: all 0.3s ease;
    }

    .upload-section:hover {
      border-color: #007bff;
      background: #e3f2fd;
    }

    .upload-section.dragover {
      border-color: #28a745;
      background: #d4edda;
      transform: scale(1.02);
    }

    .file-input {
      display: none;
    }

    .upload-btn {
      background: linear-gradient(45deg, #007bff, #0056b3);
      color: white;
      border: none;
      padding: 15px 30px;
      font-size: 1.1em;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      margin: 10px;
    }

    .upload-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 123, 255, 0.3);
    }

    .settings {
      display: flex;
      gap: 20px;
      margin-bottom: 30px;
      flex-wrap: wrap;
    }

    .setting-group {
      flex: 1;
      min-width: 200px;
    }

    .setting-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #495057;
    }

    .setting-group input {
      width: 100%;
      padding: 12px;
      border: 2px solid #dee2e6;
      border-radius: 6px;
      font-size: 1em;
      transition: border-color 0.3s ease;
    }

    .setting-group input:focus {
      outline: none;
      border-color: #007bff;
      box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
    }

    .analyze-btn {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
      border: none;
      padding: 15px 40px;
      font-size: 1.2em;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: 100%;
      margin-bottom: 30px;
    }

    .analyze-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(40, 167, 69, 0.3);
    }

    .analyze-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .results {
      display: none;
      animation: fadeIn 0.5s ease;
    }

    .results.show {
      display: block;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .summary-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .summary-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 25px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .summary-card:hover {
      transform: translateY(-5px);
    }

    .summary-card.danger {
      border-left: 5px solid #dc3545;
    }

    .summary-card.warning {
      border-left: 5px solid #ffc107;
    }

    .summary-card.info {
      border-left: 5px solid #17a2b8;
    }

    .summary-card.success {
      border-left: 5px solid #28a745;
    }

    .summary-card h3 {
      font-size: 2em;
      margin-bottom: 10px;
      color: #495057;
    }

    .summary-card p {
      color: #6c757d;
      font-weight: 500;
    }

    .client-card {
      background: white;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      margin-bottom: 20px;
      overflow: hidden;
      box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
    }

    .client-header {
      background: linear-gradient(45deg, #495057, #6c757d);
      color: white;
      padding: 20px;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .client-header:hover {
      background: linear-gradient(45deg, #343a40, #495057);
    }

    .client-header h3 {
      font-size: 1.3em;
      margin-bottom: 5px;
    }

    .client-details {
      padding: 20px;
      border-top: 1px solid #dee2e6;
    }

    .invoice-item {
      background: #f8f9fa;
      border-left: 4px solid #dc3545;
      padding: 15px;
      margin-bottom: 10px;
      border-radius: 0 6px 6px 0;
      transition: transform 0.2s ease;
    }

    .invoice-item:hover {
      transform: translateX(5px);
    }

    .invoice-item.severe {
      border-left-color: #dc3545;
      background: #f8d7da;
    }

    .invoice-item.moderate {
      border-left-color: #ffc107;
      background: #fff3cd;
    }

    .invoice-meta {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 10px;
    }

    .amount {
      font-weight: bold;
      font-size: 1.1em;
      color: #dc3545;
    }

    .days-overdue {
      background: #dc3545;
      color: white;
      padding: 4px 8px;
      border-radius: 15px;
      font-size: 0.9em;
      font-weight: bold;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6c757d;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    .error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      border-radius: 6px;
      padding: 15px;
      margin-bottom: 20px;
    }

    .file-type-badge {
      display: inline-block;
      background: #007bff;
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8em;
      margin-left: 10px;
      text-transform: uppercase;
    }

    .file-type-badge.xlsx {
      background: #28a745;
    }

    .chart-wrapper {
      max-width: 600px;
      margin: 0 auto 30px;
    }

    .chart-legend {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      margin-top: 10px;
      gap: 10px;
      font-size: 0.9em;
    }

    .chart-legend .legend-item {
      display: flex;
      align-items: center;
    }

    .chart-legend .legend-color {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    @media (max-width: 768px) {
      .content {
        padding: 20px;
      }

      .settings {
        flex-direction: column;
      }

      .invoice-meta {
        flex-direction: column;
        align-items: flex-start;
      }
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="header">
      <h1>üìä Analizor Facturi Restante</h1>
      <p>Sistem de Monitorizare PlƒÉ»õi Restante</p>
    </div>

    <div class="content">
      <div class="upload-section" id="uploadSection">
        <h3>üìÅ √éncarcƒÉ Fi»ôierul cu Facturi</h3>
        <p style="margin: 15px 0; color: #6c757d;">
          SelecteazƒÉ sau trage fi»ôierul cu situa»õia clien»õilor aici
        </p>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
        <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
          üìÇ SelecteazƒÉ Fi»ôier
        </button>
        <p style="margin-top: 15px; font-size: 0.9em; color: #6c757d;">
          Formate acceptate: .xlsx, .xls
        </p>
      </div>

      <div class="settings">
        <div class="setting-group">
          <label for="overdueDays">‚è∞ Zile Restan»õƒÉ (pragul)</label>
          <input type="number" id="overdueDays" value="45" min="1" max="365">
        </div>
        <div class="setting-group">
          <label for="analysisDate">üìÖ Data Analizei</label>
          <input type="date" id="analysisDate">
        </div>
      </div>

      <button class="analyze-btn" id="analyzeBtn" onclick="analyzeFile()" disabled>
        üîç AnalizeazƒÉ Facturi Restante
      </button>

      <div id="results" class="results">
        <!-- Results will be displayed here -->
      </div>
    </div>
  </div>

  <script>
    // Set today's date as default
    document.getElementById('analysisDate').valueAsDate = new Date();

    let fileContent = null;
    let fileType = null;
    let workbookData = null;
    let debtChart = null;

    Chart.register(ChartDataLabels);

    // File upload handling
    const fileInput = document.getElementById('fileInput');
    const uploadSection = document.getElementById('uploadSection');
    const analyzeBtn = document.getElementById('analyzeBtn');

    fileInput.addEventListener('change', handleFileSelect);

    // Drag and drop functionality
    uploadSection.addEventListener('dragover', (e) => {
      e.preventDefault();
      uploadSection.classList.add('dragover');
    });

    uploadSection.addEventListener('dragleave', () => {
      uploadSection.classList.remove('dragover');
    });

    uploadSection.addEventListener('drop', (e) => {
      e.preventDefault();
      uploadSection.classList.remove('dragover');
      const files = e.dataTransfer.files;
      if (files.length > 0) {
        handleFile(files[0]);
      }
    });

    function handleFileSelect(e) {
      const file = e.target.files[0];
      if (file) {
        handleFile(file);
      }
    }

    function getFileType(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      return ext;
    }

    function handleFile(file) {
      const extension = getFileType(file.name);
      fileType = extension;

      if (extension === 'xlsx' || extension === 'xls') {
        const reader = new FileReader();
        reader.onload = function (e) {
          try {
            const data = new Uint8Array(e.target.result);
            // Add codepage option for proper encoding
            const workbook = XLSX.read(data, {
              type: 'array',
              codepage: 1250,
              cellText: false,
              cellDates: true
            });
            workbookData = workbook;

            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            let rawContent = XLSX.utils.sheet_to_txt(firstSheet, {FS: '\t'});
            // Clean the content - remove null bytes and other unwanted characters
            fileContent = rawContent
              .replace(/\x00/g, '')          // Remove null bytes (^@)
              .replace(/\uFEFF/g, '')        // Remove BOM if present
              .replace(/√ø√æ/g, '')           // UTF-16 BOM as literal characters
              .replace(/[\x00-\x08\x0E-\x1F\x7F]/g, '') // Remove other control characters
              // Normalize whitespace
              .replace(/\t+/g, '\t')         // Multiple tabs ‚Üí single tab
              .replace(/\s*\n\s*/g, '\n')    // Clean up line breaks
              .replace(/\s+$/gm, '')         // Remove trailing spaces on each line
              .trim();                       // Remove leading/trailing whitespace

            console.log("Cleaned content:", fileContent);

            analyzeBtn.disabled = false;
            showFileLoaded(file.name, file.size, extension);
          } catch (error) {
            alert('Eroare la citirea fi»ôierului Excel: ' + error.message);
          }
        };
        reader.readAsArrayBuffer(file);
      }
    }

    function showFileLoaded(filename, filesize, extension) {
      const badgeColor = {
        'xlsx': 'xlsx',
        'xls': 'xlsx'
      }[extension];

      uploadSection.innerHTML = `
                <h3>‚úÖ Fi»ôier √éncƒÉrcat</h3>
                <p style="color: #28a745; font-weight: bold;">
                    ${filename}
                    <span class="file-type-badge ${badgeColor}">${extension}</span>
                </p>
                <p style="color: #6c757d;">MƒÉrime: ${(filesize / 1024).toFixed(1)} KB</p>
                <button class="upload-btn" onclick="location.reload()">
                    üîÑ SchimbƒÉ Fi»ôierul
                </button>
            `;
    }

    function analyzeFile() {
      if (!fileContent) {
        alert('Te rog sƒÉ √Æncarci mai √Ænt√¢i un fi»ôier!');
        return;
      }

      const resultsDiv = document.getElementById('results');
      resultsDiv.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Se analizeazƒÉ fi»ôierul${fileType === 'xlsx' || fileType === 'xls' ? ' Excel' : ''}...</p>
                </div>
            `;
      resultsDiv.classList.add('show');

      // Small delay to show loading animation
      setTimeout(() => {
        performAnalysis();
      }, 500);
    }

    function performAnalysis() {
      try {
        const overdueDays = parseInt(document.getElementById('overdueDays').value);
        const analysisDate = new Date(document.getElementById('analysisDate').value);

        const results = analyzeInvoiceData(fileContent, overdueDays, analysisDate);
        displayResults(results);

      } catch (error) {
        document.getElementById('results').innerHTML = `
                    <div class="error">
                        <h3>‚ùå Eroare la AnalizƒÉ</h3>
                        <p>${error.message}</p>
                        <p style="margin-top: 10px; font-size: 0.9em;">
                            VerificƒÉ dacƒÉ formatul fi»ôierului este corect »ôi datele sunt √Æn formatul DD.MM.YYYY.
                        </p>
                    </div>
                `;
      }
    }

    function parseDate(dateStr) {
      // Handle both DD.MM.YYYY and DD/MM/YYYY formats
      const separators = ['.', '/'];
      let parts = null;

      for (const sep of separators) {
        if (dateStr.includes(sep)) {
          parts = dateStr.split(sep);
          break;
        }
      }

      if (parts && parts.length === 3) {
        return new Date(
          parseInt(parts[2]),
          parseInt(parts[1]) - 1,
          parseInt(parts[0])
        );
      }

      // Try parsing Excel serial date if it's a number
      const serialDate = parseFloat(dateStr);
      if (!isNaN(serialDate) && serialDate > 0) {
        // Excel serial date: days since 1900-01-01 (with leap year bug)
        const excelEpoch = new Date(1900, 0, 1);
        const msPerDay = 24 * 60 * 60 * 1000;
        const date = new Date(excelEpoch.getTime() + (serialDate - 2) * msPerDay);
        return date;
      }

      return null;
    }

    function analyzeInvoiceData(content, overdueDays, analysisDate) {
      const lines = content.split('\n');
      let currentClient = '';
      let currentClientInfo = '';
      const overdueClients = [];
      let totalOverdueAmount = 0;
      let totalOverdueCount = 0;
      let isInDataSection = false;

      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        const trimmedLine = line.trim();

        // Skip empty lines and separators
        if (!trimmedLine || trimmedLine.startsWith('- - -')) {
          continue;
        }

        // Skip header lines
        if (trimmedLine.includes('SITUATIE CLIENTI') ||
          trimmedLine.includes('Data\t') ||
          trimmedLine.includes('Sold contabil') ||
          trimmedLine.includes('Pagina 1/1')) {
          continue;
        }
        // Check if this is a "Total la" line
        if (line.startsWith('Total la')) {
          currentClient = '';
          currentClientInfo = '';
          isInDataSection = false;
          console.log("total:", line);
          continue;
        }
        // Detect client name (company line without leading tab)
        const companyIndicators = ['SRL', 'S.R.L.', 'SA', 'S.A.', 'PFA', 'II', 'IF', 'INTREPRINDERE INDIVIDUALA'];
        let isCompanyLine = false;
        for (const indicator of companyIndicators) {
          if (line.includes(indicator) && !line.startsWith('\t') && !line.includes('Total la')) {
            isCompanyLine = true;
            break;
          }
        }

        if (isCompanyLine) {
          console.log("company:", line);
          // Extract company name (everything before the first tab)
          const parts = line.split('\t');
          currentClient = parts[0].trim();
          // Look for address in remaining parts
          if (parts.length > 1) {
            currentClientInfo = parts.slice(1).join(' ').trim();
          }
          isInDataSection = true;
          continue;
        }

        // Parse invoice lines (lines starting with tab)
        if (currentClient && isInDataSection) {
          const parts = line.split('\t').filter(p => p.length > 0);
          console.log("factura:", parts);
          // Invoice data lines should have at least 8 parts:
          // Date, Scadent (Due Date), Nr. document, Cont, Neachitat initial, Total, Incasari, Neachitat final
          if (parts.length >= 8) {
            // Find the date columns (format DD.MM.YYYY)
            const datePattern = /^\d{2}\.\d{2}\.\d{4}$/;

            let dateIndex = -1;
            let dueDateIndex = -1;

            // Find date columns
            for (let j = 0; j < Math.min(parts.length, 3); j++) {
              if (datePattern.test(parts[j].trim())) {
                if (dateIndex === -1) {
                  dateIndex = j;
                } else if (dueDateIndex === -1) {
                  dueDateIndex = j;
                  break;
                }
              }
            }

            if (dueDateIndex !== -1 && parts.length > dueDateIndex + 5) {
              const dueDateStr = parts[dueDateIndex].trim();
              const docNumber = parts[dueDateIndex + 1].trim();
              // The last column is usually "Neachitat final" (final unpaid amount)
              const amountStr = parts[parts.length - 1].trim();

              const dueDate = parseDate(dueDateStr);

              if (dueDate) {
                const daysDiff = Math.floor((analysisDate - dueDate) / (1000 * 60 * 60 * 24));

                if (daysDiff >= overdueDays && dueDate < analysisDate) {
                  // Parse amount (handle both comma and period as decimal separator)
                  const amount = parseFloat(amountStr.replace(',', '.').replace(/[^\d.-]/g, '')) || 0;

                  if (amount > 0) {
                    let clientData = overdueClients.find(c => c.name === currentClient);
                    if (!clientData) {
                      clientData = {
                        name: currentClient,
                        invoices: [],
                        total: 0
                      };
                      overdueClients.push(clientData);
                    }

                    clientData.invoices.push({
                      docNumber,
                      dueDate: dueDateStr,
                      daysOverdue: daysDiff,
                      amount: amount
                    });
                    clientData.total += amount;
                    totalOverdueAmount += amount;
                    totalOverdueCount++;
                  }
                }
              }
            }
          }
        }
      }

      return {
        clients: overdueClients.sort((a, b) => b.total - a.total),
        totalAmount: totalOverdueAmount,
        totalCount: totalOverdueCount,
        analysisDate: analysisDate,
        overdueDays: overdueDays
      };
    }

    function displayResults(results) {
      const resultsDiv = document.getElementById('results');

      if (results.clients.length === 0) {
        resultsDiv.innerHTML = `
                    <div class="success">
                        <h3>‚úÖ Rezultat Excelent!</h3>
                        <p>Nu existƒÉ facturi restante cu peste ${results.overdueDays} zile!</p>
                    </div>
                `;
        return;
      }

      const avgAmount = results.totalAmount / results.totalCount;
      const priorityClients = results.clients.filter(c => c.total > avgAmount);
      const chartClients = results.clients.slice(0, Math.min(10, results.clients.length));

      let html = `
                <div class="summary-cards">
                    <div class="summary-card danger">
                        <h3>${results.totalCount}</h3>
                        <p>Facturi Restante</p>
                    </div>
                    <div class="summary-card warning">
                        <h3>${results.clients.length}</h3>
                        <p>Clien»õi cu Restan»õe</p>
                    </div>
                    <div class="summary-card info">
                        <h3>${results.totalAmount.toLocaleString('ro-RO', {maximumFractionDigits: 0})}</h3>
                        <p>RON Total Restant</p>
                    </div>
                    <div class="summary-card success">
                        <h3>${priorityClients.length}</h3>
                        <p>Clien»õi Prioritari</p>
                    </div>
                </div>`;

      if (chartClients.length >= 2) {
        html += `
                <div class="chart-wrapper">
                    <canvas id="debtChart"></canvas>
                    <div id="chartLegend" class="chart-legend"></div>
                </div>
                `;
      }

      html += `
                <h2 style="color: #495057; margin-bottom: 20px; border-bottom: 2px solid #dee2e6; padding-bottom: 10px;">
                    üìã Detalii Clien»õi cu Restan»õe
                </h2>
            `;

      results.clients.forEach((client, index) => {
        const isPriority = client.total > avgAmount;
        const maxDaysOverdue = Math.max(...client.invoices.map(inv => inv.daysOverdue));

        html += `
                    <div class="client-card">
                        <div class="client-header" onclick="toggleClient(${index})">
                            <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 10px;">
                                <div>
                                    <h3>${isPriority ? '‚ö†Ô∏è ' : ''}${client.name}</h3>
                                    <small style="opacity: 0.9;">${client.invoices.length} facturi restante</small>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 1.3em; font-weight: bold;">
                                        ${client.total.toLocaleString('ro-RO', {minimumFractionDigits: 2})} RON
                                    </div>
                                    <div style="font-size: 0.9em; opacity: 0.9;">
                                        Cel mai vechi: ${maxDaysOverdue} zile
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="client-details" id="client-${index}" style="display: none;">
                `;

        client.invoices.sort((a, b) => b.daysOverdue - a.daysOverdue).forEach(invoice => {
          const severity = invoice.daysOverdue > 90 ? 'severe' : 'moderate';
          html += `
                        <div class="invoice-item ${severity}">
                            <div class="invoice-meta">
                                <div>
                                    <strong>üìÑ ${invoice.docNumber}</strong><br>
                                    <small style="color: #6c757d;">Scadent: ${invoice.dueDate}</small>
                                </div>
                                <div style="text-align: right;">
                                    <div class="amount">${invoice.amount.toLocaleString('ro-RO', {minimumFractionDigits: 2})} RON</div>
                                    <div class="days-overdue">${invoice.daysOverdue} zile</div>
                                </div>
                            </div>
                        </div>
                    `;
        });

        html += `
                        </div>
                    </div>
                `;
      });

      // Add insights
      html += `
                <div style="background: #f8f9fa; padding: 25px; border-radius: 10px; margin-top: 30px;">
                    <h3 style="color: #495057; margin-bottom: 15px;">üìä Informa»õii Suplimentare</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <strong>Media pe facturƒÉ:</strong><br>
                            ${avgAmount.toLocaleString('ro-RO', {minimumFractionDigits: 2})} RON
                        </div>
                        <div>
                            <strong>Cel mai mare debitor:</strong><br>
                            ${results.clients[0].name}
                        </div>
                        <div>
                            <strong>Data analizei:</strong><br>
                            ${results.analysisDate.toLocaleDateString('ro-RO')}
                        </div>
                        <div>
                            <strong>Pragul restan»õƒÉ:</strong><br>
                            ${results.overdueDays} zile
                        </div>
                    </div>
                </div>
            `;

      resultsDiv.innerHTML = html;

      if (chartClients.length >= 2) {
        createDebtChart(chartClients);
      }
    }

    function toggleClient(index) {
      const details = document.getElementById(`client-${index}`);
      details.style.display = details.style.display === 'none' ? 'block' : 'none';
    }

    function createDebtChart(clients) {
      const ctx = document.getElementById('debtChart').getContext('2d');
      const labels = clients.map(c => c.name);
      const data = clients.map(c => c.total);
      const colors = labels.map((_, i) => `hsl(${(i * 360) / labels.length}, 70%, 50%)`);
      const total = data.reduce((a, b) => a + b, 0);

      if (debtChart) {
        debtChart.destroy();
      }

      debtChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels: labels,
          datasets: [{
            data: data,
            backgroundColor: colors
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed;
                  const pct = ((value / total) * 100).toFixed(1);
                  return `${context.label}: ${value.toLocaleString('ro-RO', {minimumFractionDigits: 2})} RON (${pct}%)`;
                }
              }
            },
            datalabels: {
              color: '#fff',
              formatter: (value) => `${((value / total) * 100).toFixed(1)}%`
            }
          }
        }
      });

      const legend = document.getElementById('chartLegend');
      legend.innerHTML = '';
      clients.forEach((client, i) => {
        const amount = client.total.toLocaleString('ro-RO', {minimumFractionDigits: 2});
        legend.innerHTML += `<div class="legend-item"><span class="legend-color" style="background:${colors[i]}"></span>${client.name}: ${amount} RON</div>`;
      });
    }
  </script>
</body>

</html>
